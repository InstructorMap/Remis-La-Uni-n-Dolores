<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Panel Admin - Remiser√≠a</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #f0f2f5; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .logo-preview {
            width: 200px;
            height: 200px;
            border: 3px dashed #ccc;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f9f9f9;
        }
        
        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-right: 10px;
        }
        
        .button:hover { background: #5a67d8; }
        .button-success { background: #48bb78; }
        .button-success:hover { background: #38a169; }
        .button-danger { background: #f56565; }
        .button-danger:hover { background: #e53e3e; }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        .status-success {
            background: #c6f6d5;
            color: #22543d;
            display: block;
        }
        .status-error {
            background: #fed7d7;
            color: #742a2a;
            display: block;
        }
        
        .preview-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .preview-header {
            background: var(--preview-primary, #ffd700);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #1a1a1a;
            margin-bottom: 15px;
        }
        .preview-phone {
            background: #1a1a1a;
            color: var(--preview-primary, #ffd700);
            padding: 8px 15px;
            border-radius: 50px;
            text-decoration: none;
        }
        .preview-fare {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .color-input {
            width: 60px;
            height: 60px;
            padding: 0;
            border: 2px solid #ddd;
            cursor: pointer;
        }
        
        .tab {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Panel de Administraci√≥n - Remiser√≠a</h1>
            <p>Configura todos los datos de tu negocio en un solo lugar</p>
        </div>

        <!-- Login Section -->
        <div class="card" id="loginSection">
            <h2>üîê Acceso Administrador</h2>
            <div class="info-box">
                Usa las mismas credenciales que en la app principal. 
                El primer usuario registrado ser√° admin autom√°ticamente.
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="adminEmail" placeholder="admin@remiseria.com" value="admin@test.com">
            </div>
            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="adminPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="123456">
            </div>
            <button class="button" onclick="adminLogin()">Iniciar Sesi√≥n como Admin</button>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" style="display: none;">
            <div id="statusMessage" class="status-message"></div>

            <!-- Tabs -->
            <div class="tab">
                <button class="tab-btn active" onclick="switchTab('general')">üè¢ General</button>
                <button class="tab-btn" onclick="switchTab('tarifas')">üí∞ Tarifas</button>
                <button class="tab-btn" onclick="switchTab('contacto')">üìû Contacto</button>
                <button class="tab-btn" onclick="switchTab('diseno')">üé® Dise√±o</button>
                <button class="tab-btn" onclick="switchTab('datos')">üìä Datos</button>
            </div>

            <!-- Panel General -->
            <div id="tab-general" class="tab-panel active">
                <div class="card">
                    <h2>üè¢ Informaci√≥n General</h2>
                    
                    <div class="form-group">
                        <label>Nombre del Rem√≠s</label>
                        <input type="text" id="remisName" placeholder="Ej: Remis La Uni√≥n - Dolores">
                    </div>
                    
                    <div class="form-group">
                        <label>Logo (JPG/PNG)</label>
                        <input type="file" id="logoInput" accept="image/*" onchange="previewLogo(event)">
                        <div class="logo-preview" id="logoPreview">
                            <span>Vista previa</span>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Direcci√≥n (opcional)</label>
                            <input type="text" id="remisAddress" placeholder="Av. Principal 123, Dolores">
                        </div>
                        <div class="form-group">
                            <label>Coordenadas (opcional)</label>
                            <input type="text" id="remisCoords" placeholder="-34.6037, -58.3816">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>‚è∞ Horarios</h2>
                    <div class="form-group">
                        <select id="scheduleType" onchange="toggleCustomSchedule()">
                            <option value="24h">Atenci√≥n las 24 horas</option>
                            <option value="custom">Horario personalizado</option>
                        </select>
                    </div>
                    
                    <div id="customSchedule" style="display: none;">
                        <div class="grid-3">
                            <div class="form-group">
                                <label>Lunes a Viernes</label>
                                <input type="text" id="weekdayHours" value="8:00 - 22:00">
                            </div>
                            <div class="form-group">
                                <label>S√°bados</label>
                                <input type="text" id="saturdayHours" value="9:00 - 20:00">
                            </div>
                            <div class="form-group">
                                <label>Domingos</label>
                                <input type="text" id="sundayHours" value="10:00 - 18:00">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Mensaje de bienvenida (opcional)</label>
                        <textarea id="welcomeMessage" rows="3" placeholder="¬°Bienvenido a nuestra app!..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Panel Tarifas -->
            <div id="tab-tarifas" class="tab-panel">
                <div class="card">
                    <h2>üí∞ Configuraci√≥n de Tarifas</h2>
                    
                    <div class="info-box">
                        üìç <strong>Regla de negocio:</strong> Viaje local (25 cuadras) = $<span id="previewBaseFare">3500</span>
                    </div>
                    
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Viaje base (25 cuadras)</label>
                            <input type="number" id="baseFare" value="3500" step="100" min="0">
                        </div>
                        <div class="form-group">
                            <label>Cuadra extra ($)</label>
                            <input type="number" id="extraBlockRate" value="150" step="10" min="0">
                        </div>
                        <div class="form-group">
                            <label>Minuto de espera ($)</label>
                            <input type="number" id="waitingRate" value="150" step="10" min="0">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Comisi√≥n de la remiser√≠a (%)</label>
                            <input type="number" id="commissionRate" value="20" step="1" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Metros por cuadra</label>
                            <input type="number" id="metersPerBlock" value="120" step="10" min="50" max="200">
                            <small style="color: #666;">Valor aproximado: 100-130m seg√∫n la ciudad</small>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Tarifa m√≠nima ($)</label>
                            <input type="number" id="minimumFare" value="500" step="50">
                        </div>
                        <div class="form-group">
                            <label>Tarifa nocturna (opcional)</label>
                            <input type="number" id="nightSurcharge" value="0" step="10" placeholder="Ej: 20% extra">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Horario nocturno desde</label>
                            <input type="time" id="nightStart" value="22:00">
                        </div>
                        <div class="form-group">
                            <label>Horario nocturno hasta</label>
                            <input type="time" id="nightEnd" value="06:00">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>üßÆ Calculadora de Prueba</h2>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Cuadras a probar</label>
                            <input type="number" id="testBlocks" value="30" min="1">
                        </div>
                        <div class="form-group">
                            <label>Minutos espera</label>
                            <input type="number" id="testMinutes" value="5" min="0">
                        </div>
                        <div class="form-group">
                            <button class="button" onclick="testFare()" style="margin-top: 24px;">Calcular</button>
                        </div>
                    </div>
                    <div id="testResult" style="background: #f0f0f0; padding: 15px; border-radius: 10px; font-size: 18px;">
                        Precio: $0
                    </div>
                </div>
            </div>

            <!-- Panel Contacto -->
            <div id="tab-contacto" class="tab-panel">
                <div class="card">
                    <h2>üìû Informaci√≥n de Contacto</h2>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Tel√©fono principal</label>
                            <input type="tel" id="phoneMain" placeholder="2244-567890">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono secundario</label>
                            <input type="tel" id="phoneSecondary" placeholder="2244-123456">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="hasWhatsapp" checked> 
                            ¬øEl tel√©fono principal es WhatsApp?
                        </label>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Email de contacto</label>
                            <input type="email" id="contactEmail" placeholder="info@remiseria.com">
                        </div>
                        <div class="form-group">
                            <label>Sitio web (opcional)</label>
                            <input type="url" id="website" placeholder="https://...">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>üåê Redes Sociales</h2>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Instagram</label>
                            <input type="url" id="instagram" placeholder="https://instagram.com/...">
                        </div>
                        <div class="form-group">
                            <label>Facebook</label>
                            <input type="url" id="facebook" placeholder="https://facebook.com/...">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Twitter/X</label>
                            <input type="url" id="twitter" placeholder="https://twitter.com/...">
                        </div>
                        <div class="form-group">
                            <label>WhatsApp Business</label>
                            <input type="url" id="whatsapp" placeholder="https://wa.me/...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel Dise√±o -->
            <div id="tab-diseno" class="tab-panel">
                <div class="card">
                    <h2>üé® Personalizaci√≥n Visual</h2>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Color principal</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="color" id="primaryColor" value="#ffd700" class="color-input">
                                <input type="text" id="primaryColorText" value="#ffd700" placeholder="#ffd700">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Color secundario</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="color" id="secondaryColor" value="#1a1a1a" class="color-input">
                                <input type="text" id="secondaryColorText" value="#1a1a1a" placeholder="#1a1a1a">
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Color de texto</label>
                            <input type="color" id="textColor" value="#333333">
                        </div>
                        <div class="form-group">
                            <label>Color de botones</label>
                            <input type="color" id="buttonColor" value="#4CAF50">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Estilo de mapa</label>
                        <select id="mapStyle">
                            <option value="streets">Calles</option>
                            <option value="satellite">Satelital</option>
                            <option value="dark">Oscuro</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <h2>üî§ Textos Personalizados</h2>
                    
                    <div class="form-group">
                        <label>T√≠tulo de bienvenida</label>
                        <input type="text" id="welcomeTitle" value="¬°Bienvenido a nuestra app!">
                    </div>
                    
                    <div class="form-group">
                        <label>Mensaje para pasajeros</label>
                        <textarea id="passengerMessage" rows="2">Solicita tu viaje de manera f√°cil y r√°pida</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Mensaje para conductores</label>
                        <textarea id="driverMessage" rows="2">Conecta con pasajeros y aumenta tus ganancias</textarea>
                    </div>
                </div>
            </div>

            <!-- Panel Datos -->
            <div id="tab-datos" class="tab-panel">
                <div class="card">
                    <h2>üìä Estad√≠sticas en Vivo</h2>
                    
                    <div class="grid-3" style="text-align: center;">
                        <div style="background: #f0f0f0; padding: 20px; border-radius: 10px;">
                            <div style="font-size: 14px; color: #666;">Usuarios</div>
                            <div style="font-size: 32px; font-weight: bold;" id="statUsers">0</div>
                        </div>
                        <div style="background: #f0f0f0; padding: 20px; border-radius: 10px;">
                            <div style="font-size: 14px; color: #666;">Viajes hoy</div>
                            <div style="font-size: 32px; font-weight: bold;" id="statRides">0</div>
                        </div>
                        <div style="background: #f0f0f0; padding: 20px; border-radius: 10px;">
                            <div style="font-size: 14px; color: #666;">Ganancias</div>
                            <div style="font-size: 32px; font-weight: bold;" id="statEarnings">$0</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3>üìã √öltimos viajes</h3>
                        <div id="recentRides" style="max-height: 300px; overflow-y: auto;">
                            <!-- Se llena con JS -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>‚öôÔ∏è Acciones de Base de Datos</h2>
                    
                    <div class="grid-2">
                        <button class="button" onclick="exportData()">üì§ Exportar configuraci√≥n</button>
                        <button class="button" onclick="importData()">üì• Importar configuraci√≥n</button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="button-danger" onclick="resetAllData()" style="width: 100%;">
                            ‚ö†Ô∏è Restablecer todos los datos
                        </button>
                    </div>
                </div>
            </div>

            <!-- Vista Previa -->
            <div class="card">
                <h2>üëÅÔ∏è Vista Previa en Vivo</h2>
                <div class="preview-card" id="livePreview"></div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div style="display: flex; gap: 15px; margin: 30px 0; position: sticky; bottom: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);">
                <button class="button button-success" onclick="saveConfig()" style="flex: 2;">üíæ GUARDAR CONFIGURACI√ìN</button>
                <button class="button" onclick="previewConfig()" style="flex: 1;">üëÅÔ∏è Actualizar Vista</button>
                <button class="button button-danger" onclick="resetConfig()" style="flex: 1;">‚Ü∫ Restablecer</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE - ¬°MISMA QUE EN INDEX!
        // ============================================
        const SUPABASE_URL = 'https://tmccuhzqyfgjaerqydmr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtY2N1aHpxeWZnamFlcnF5ZG1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjUxNTMsImV4cCI6MjA4NzEwMTE1M30.RZyzaN1a35DgNT4N70D5oxvFbliMoKcNgFc16C4zz9E';
        
        const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let logoBase64 = null;
        let currentConfig = {};

        // ============================================
        // LOGIN DE ADMIN
        // ============================================
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                // Verificar si es admin (primer usuario o rol admin)
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('user_role')
                    .eq('id', data.user.id)
                    .single();
                
                // Por simplicidad, el primer usuario es admin
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadConfig();
                loadStats();
                
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // ============================================
        // CARGAR CONFIGURACI√ìN
        // ============================================
        async function loadConfig() {
            try {
                const { data, error } = await supabase
                    .from('config')
                    .select('data')
                    .eq('id', 1)
                    .single();
                
                if (data && data.data) {
                    currentConfig = data.data;
                    populateForm(currentConfig);
                }
            } catch (error) {
                console.log('No hay configuraci√≥n previa');
            }
            updateLivePreview();
        }

        function populateForm(config) {
            // General
            setValue('remisName', config.remisName);
            setValue('remisAddress', config.remisAddress);
            setValue('remisCoords', config.remisCoords);
            setValue('scheduleType', config.scheduleType);
            setValue('weekdayHours', config.weekdayHours);
            setValue('saturdayHours', config.saturdayHours);
            setValue('sundayHours', config.sundayHours);
            setValue('welcomeMessage', config.welcomeMessage);
            
            // Tarifas
            setValue('baseFare', config.baseFare);
            setValue('extraBlockRate', config.extraBlockRate);
            setValue('waitingRate', config.waitingRate);
            setValue('commissionRate', config.commissionRate);
            setValue('metersPerBlock', config.metersPerBlock);
            setValue('minimumFare', config.minimumFare);
            setValue('nightSurcharge', config.nightSurcharge);
            setValue('nightStart', config.nightStart);
            setValue('nightEnd', config.nightEnd);
            
            // Contacto
            setValue('phoneMain', config.phoneMain);
            setValue('phoneSecondary', config.phoneSecondary);
            setValue('hasWhatsapp', config.hasWhatsapp);
            setValue('contactEmail', config.contactEmail);
            setValue('website', config.website);
            
            // Redes
            setValue('instagram', config.instagram);
            setValue('facebook', config.facebook);
            setValue('twitter', config.twitter);
            setValue('whatsapp', config.whatsapp);
            
            // Dise√±o
            setValue('primaryColor', config.primaryColor);
            setValue('primaryColorText', config.primaryColor);
            setValue('secondaryColor', config.secondaryColor);
            setValue('secondaryColorText', config.secondaryColor);
            setValue('textColor', config.textColor);
            setValue('buttonColor', config.buttonColor);
            setValue('mapStyle', config.mapStyle);
            setValue('welcomeTitle', config.welcomeTitle);
            setValue('passengerMessage', config.passengerMessage);
            setValue('driverMessage', config.driverMessage);
            
            if (config.logo) {
                logoBase64 = config.logo;
                document.getElementById('logoPreview').innerHTML = `<img src="${logoBase64}" alt="Logo">`;
            }
            
            toggleCustomSchedule();
        }

        function setValue(id, value) {
            const el = document.getElementById(id);
            if (el) {
                if (el.type === 'checkbox') el.checked = !!value;
                else el.value = value || '';
            }
        }

        // ============================================
        // GUARDAR CONFIGURACI√ìN
        // ============================================
        async function saveConfig() {
            const config = {
                // General
                remisName: getValue('remisName'),
                remisAddress: getValue('remisAddress'),
                remisCoords: getValue('remisCoords'),
                scheduleType: getValue('scheduleType'),
                weekdayHours: getValue('weekdayHours'),
                saturdayHours: getValue('saturdayHours'),
                sundayHours: getValue('sundayHours'),
                welcomeMessage: getValue('welcomeMessage'),
                
                // Tarifas
                baseFare: parseFloat(getValue('baseFare')) || 3500,
                extraBlockRate: parseFloat(getValue('extraBlockRate')) || 150,
                waitingRate: parseFloat(getValue('waitingRate')) || 150,
                commissionRate: parseFloat(getValue('commissionRate')) || 20,
                metersPerBlock: parseFloat(getValue('metersPerBlock')) || 120,
                minimumFare: parseFloat(getValue('minimumFare')) || 500,
                nightSurcharge: parseFloat(getValue('nightSurcharge')) || 0,
                nightStart: getValue('nightStart'),
                nightEnd: getValue('nightEnd'),
                
                // Contacto
                phoneMain: getValue('phoneMain'),
                phoneSecondary: getValue('phoneSecondary'),
                hasWhatsapp: document.getElementById('hasWhatsapp')?.checked || false,
                contactEmail: getValue('contactEmail'),
                website: getValue('website'),
                
                // Redes
                instagram: getValue('instagram'),
                facebook: getValue('facebook'),
                twitter: getValue('twitter'),
                whatsapp: getValue('whatsapp'),
                
                // Dise√±o
                primaryColor: getValue('primaryColor'),
                secondaryColor: getValue('secondaryColor'),
                textColor: getValue('textColor'),
                buttonColor: getValue('buttonColor'),
                mapStyle: getValue('mapStyle'),
                welcomeTitle: getValue('welcomeTitle'),
                passengerMessage: getValue('passengerMessage'),
                driverMessage: getValue('driverMessage'),
                
                // Logo
                logo: logoBase64,
                
                updatedAt: new Date().toISOString()
            };

            try {
                const { error } = await supabase
                    .from('config')
                    .upsert({ id: 1, data: config });
                
                if (error) throw error;
                
                currentConfig = config;
                showStatus('‚úÖ Configuraci√≥n guardada correctamente', 'success');
                updateLivePreview();
                
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }

        function getValue(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }

        // ============================================
        // VISTA PREVIA
        // ============================================
        function updateLivePreview() {
            const preview = document.getElementById('livePreview');
            const primary = getValue('primaryColor') || '#ffd700';
            const secondary = getValue('secondaryColor') || '#1a1a1a';
            
            preview.innerHTML = `
                <style>
                    .preview-header { background: ${primary}; }
                    .preview-phone { background: ${secondary}; color: ${primary}; }
                </style>
                <div class="preview-header">
                    ${logoBase64 ? 
                        `<img src="${logoBase64}" style="height: 50px; width: auto;">` : 
                        '<span style="font-size: 40px;">üöñ</span>'
                    }
                    <div style="flex: 1; font-weight: bold;">${getValue('remisName') || 'Remis La Uni√≥n'}</div>
                    <div class="preview-phone">üìû ${getValue('phoneMain') || '2244-567890'}</div>
                </div>
                <div class="preview-fare">
                    <div>
                        <strong>Tarifa base:</strong><br>
                        25 cuadras = $${getValue('baseFare') || 3500}
                    </div>
                    <div>
                        <strong>Cuadra extra:</strong><br>
                        $${getValue('extraBlockRate') || 150}
                    </div>
                    <div>
                        <strong>Espera/min:</strong><br>
                        $${getValue('waitingRate') || 150}
                    </div>
                </div>
                <div style="margin-top: 10px; color: #666;">
                    ${getValue('scheduleType') === '24h' ? 'üïê 24 horas' : 
                        `üïê ${getValue('weekdayHours') || '8:00-22:00'}`
                    }
                </div>
            `;
        }

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        function previewLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoBase64 = e.target.result;
                    document.getElementById('logoPreview').innerHTML = `<img src="${logoBase64}" alt="Logo">`;
                    updateLivePreview();
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleCustomSchedule() {
            const type = document.getElementById('scheduleType').value;
            document.getElementById('customSchedule').style.display = 
                type === 'custom' ? 'block' : 'none';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            event.target.classList.add('active');
        }

        function testFare() {
            const blocks = parseInt(document.getElementById('testBlocks').value) || 30;
            const minutes = parseInt(document.getElementById('testMinutes').value) || 0;
            
            const baseFare = parseFloat(getValue('baseFare')) || 3500;
            const extraRate = parseFloat(getValue('extraBlockRate')) || 150;
            const waitingRate = parseFloat(getValue('waitingRate')) || 150;
            const commission = (parseFloat(getValue('commissionRate')) || 20) / 100;
            
            let cost = baseFare;
            if (blocks > 25) {
                cost += (blocks - 25) * extraRate;
            }
            cost += minutes * waitingRate;
            
            const total = cost * (1 + commission);
            
            document.getElementById('testResult').innerHTML = `
                <strong>Precio final:</strong> $${Math.round(total)}<br>
                <small style="color: #666;">
                    Subtotal: $${cost} | Comisi√≥n: $${Math.round(cost * commission)}
                </small>
            `;
        }

        async function loadStats() {
            // Cargar estad√≠sticas desde Supabase
            const { count: users } = await supabase
                .from('profiles')
                .select('*', { count: 'exact', head: true });
            
            const today = new Date().toISOString().split('T')[0];
            const { data: rides } = await supabase
                .from('rides')
                .select('*')
                .gte('created_at', today);
            
            document.getElementById('statUsers').textContent = users || 0;
            document.getElementById('statRides').textContent = rides?.length || 0;
            
            const earnings = rides?.reduce((sum, r) => sum + (r.fare?.total || 0), 0) || 0;
            document.getElementById('statEarnings').textContent = `$${earnings}`;
            
            // √öltimos viajes
            const { data: recent } = await supabase
                .from('rides')
                .select('*, passenger:profiles!passenger_id(full_name)')
                .order('created_at', { ascending: false })
                .limit(5);
            
            const recentHtml = recent?.map(r => `
                <div style="padding: 10px; border-bottom: 1px solid #eee;">
                    <div><strong>${r.passenger?.full_name || 'Pasajero'}</strong></div>
                    <div style="display: flex; justify-content: space-between; color: #666;">
                        <span>${new Date(r.created_at).toLocaleTimeString()}</span>
                        <span>$${r.fare?.total || 0}</span>
                    </div>
                </div>
            `).join('') || '<p>No hay viajes</p>';
            
            document.getElementById('recentRides').innerHTML = recentHtml;
        }

        function showStatus(message, type) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.className = `status-message status-${type}`;
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        function previewConfig() {
            updateLivePreview();
            showStatus('Vista previa actualizada', 'success');
        }

        function resetConfig() {
            if (confirm('¬øRestablecer toda la configuraci√≥n a valores por defecto?')) {
                logoBase64 = null;
                document.getElementById('logoPreview').innerHTML = '<span>Vista previa</span>';
                
                // Resetear campos
                setValue('remisName', 'Remis La Uni√≥n - Dolores');
                setValue('phoneMain', '2244-567890');
                setValue('baseFare', '3500');
                setValue('extraBlockRate', '150');
                setValue('waitingRate', '150');
                setValue('commissionRate', '20');
                setValue('primaryColor', '#ffd700');
                setValue('secondaryColor', '#1a1a1a');
                
                updateLivePreview();
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(currentConfig, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `remis-config-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const config = JSON.parse(e.target.result);
                        populateForm(config);
                        showStatus('Configuraci√≥n importada', 'success');
                    } catch {
                        showStatus('Archivo inv√°lido', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetAllData() {
            if (confirm('¬øEst√°s SEGURO? Esto eliminar√° TODOS los datos. Esta acci√≥n no se puede deshacer.')) {
                // Implementar l√≥gica de reset
                showStatus('Funci√≥n deshabilitada por seguridad', 'error');
            }
        }

        // Sincronizar colores con inputs de texto
        document.getElementById('primaryColor')?.addEventListener('input', (e) => {
            document.getElementById('primaryColorText').value = e.target.value;
            updateLivePreview();
        });
        document.getElementById('secondaryColor')?.addEventListener('input', (e) => {
            document.getElementById('secondaryColorText').value = e.target.value;
            updateLivePreview();
        });
        
        // Actualizar preview con cada cambio
        ['remisName', 'phoneMain', 'baseFare', 'extraBlockRate', 'waitingRate', 'scheduleType', 'weekdayHours'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', updateLivePreview);
        });

        // Inicializar
        setInterval(loadStats, 30000); // Actualizar stats cada 30 segundos
    </script>
</body>
</html>
