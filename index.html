<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöñ Remis La Uni√≥n - Dolores</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { height: 100vh; overflow: hidden; background: #f0f2f5; }
        #app { height: 100%; display: flex; flex-direction: column; }

        /* Header con logo - AHORA EN VERDE */
        .app-header {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 70px;
        }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 60%;
        }
        .logo-image {
            height: 50px;
            width: auto;
            max-width: 150px;
            object-fit: contain;
        }
        .logo-text {
            font-size: 18px;
            font-weight: 800;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .contact-phone {
            background: #1a1a1a;
            color: #4CAF50;
            padding: 8px 15px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        /* Navegaci√≥n inferior */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 10px 0;
            border-top: 1px solid #ddd;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 20px;
            transition: all 0.3s;
        }
        .nav-item.active {
            background: #4CAF50;
            color: white;
        }
        .nav-item i { font-size: 24px; margin-bottom: 2px; }

        /* Mapa */
        #map {
            height: calc(100% - 70px);
            width: 100%;
            z-index: 1;
        }

        /* Panel deslizable */
        .slide-panel {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 900;
            max-height: 70vh;
            overflow-y: auto;
        }
        .slide-panel.open {
            transform: translateY(0);
        }
        .panel-handle {
            width: 50px;
            height: 5px;
            background: #ccc;
            border-radius: 3px;
            margin: 0 auto 15px;
            cursor: pointer;
        }
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #2E7D32;
        }

        /* Botones */
        .btn-primary {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            margin: 5px 0;
            transition: background 0.3s;
        }
        .btn-primary:hover { background: #2E7D32; }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: white;
            color: #333;
            border: 2px solid #4CAF50;
            padding: 13px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            transition: all 0.3s;
        }
        .btn-secondary:hover {
            background: #4CAF50;
            color: white;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
        }

        /* Tarjeta de tarifa */
        .fare-estimate {
            background: #E8F5E9;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #4CAF50;
        }
        .fare-price {
            font-size: 24px;
            font-weight: bold;
            color: #2E7D32;
        }

        /* Tarjeta de viaje */
        .ride-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }
        .ride-card h3 { color: #2E7D32; margin-bottom: 10px; }
        .ride-card p { margin: 5px 0; color: #666; }

        /* Badges de estado */
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        .status-pending { background: #FFF3E0; color: #E65100; }
        .status-accepted { background: #E8F5E9; color: #2E7D32; }
        .status-in_progress { background: #E3F2FD; color: #0D47A1; }
        .status-completed { background: #EEEEEE; color: #616161; }

        /* Driver info */
        .driver-info {
            background: #E8F5E9;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .driver-avatar {
            width: 50px;
            height: 50px;
            background: #4CAF50;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        /* Historial */
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:hover { background: #f5f5f5; }

        /* Loading */
        .loading-screen {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Login */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .login-container h1 { text-align: center; color: #2E7D32; margin-bottom: 20px; }
        .login-container input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .login-container button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 5px 0;
            cursor: pointer;
        }
        .login-container button:hover { background: #2E7D32; }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading-screen">
            <div class="spinner"></div>
            <h2>Cargando Remis La Uni√≥n...</h2>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://tmccuhzqyfgjaerqydmr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtY2N1aHpxeWZnamFlcnF5ZG1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjUxNTMsImV4cCI6MjA4NzEwMTE1M30.RZyzaN1a35DgNT4N70D5oxvFbliMoKcNgFc16C4zz9E';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: true, autoRefreshToken: true }
        });

        // ============================================
        // ESTADO GLOBAL
        // ============================================
        let currentUser = null;
        let userProfile = null;
        let userRole = 'passenger';
        let map = null;
        let userMarker = null;
        let pickupMarker = null;
        let dropoffMarker = null;
        let driverMarker = null;
        let pickup = null;
        let dropoff = null;
        let currentRide = null;
        let pendingRequests = [];
        let watchId = null;
        let activeChannel = null;

        // Configuraci√≥n del rem√≠s
        let appConfig = {
            remisName: 'Remis La Uni√≥n - Dolores',
            phoneMain: '2244-567890',
            baseFare: 3500,
            extraBlockRate: 150,
            waitingRate: 150,
            commissionRate: 20,
            logo: null
        };

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        window.addEventListener('load', init);

        async function init() {
            await loadConfig();
            
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            if (user) {
                currentUser = user;
                await loadUserProfile();
                await loadPendingRequests();
                subscribeToRides();
                startLocationTracking();
                renderMainApp();
            } else {
                renderLogin();
            }
        }

        // ============================================
        // NOTIFICACIONES
        // ============================================
        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.style.background = type === 'success' ? '#4CAF50' : '#f44336';
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.remove();
            }, 3000);
        }

        // ============================================
        // RENDERIZADO
        // ============================================
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="loading-screen">
                    <div class="login-container">
                        <h1>üöñ ${appConfig.remisName}</h1>
                        <input type="email" id="email" placeholder="Email" value="test@test.com">
                        <input type="password" id="password" placeholder="Contrase√±a" value="123456">
                        <button onclick="handleLogin()">Iniciar Sesi√≥n</button>
                        <button onclick="handleRegister()" style="background: #666;">Registrarse</button>
                        <p style="text-align: center; margin-top: 20px; color: #666;">
                            üìû ${appConfig.phoneMain}
                        </p>
                    </div>
                </div>
            `;
        }

        function renderMainApp() {
            document.getElementById('app').innerHTML = `
                <div class="app-header">
                    <div class="logo-container">
                        ${appConfig.logo ? 
                            `<img src="${appConfig.logo}" class="logo-image">` : 
                            `<span style="font-size: 30px;">üöñ</span>`
                        }
                        <span class="logo-text">${appConfig.remisName}</span>
                    </div>
                    <a href="tel:${appConfig.phoneMain}" class="contact-phone">üìû ${appConfig.phoneMain}</a>
                </div>
                
                <div id="map"></div>
                
                <div class="slide-panel" id="slidePanel">
                    <div class="panel-handle" onclick="togglePanel()"></div>
                    <div id="panelContent"></div>
                </div>
                
                <div class="bottom-nav">
                    <div class="nav-item ${userRole === 'passenger' ? 'active' : ''}" onclick="switchRole('passenger')">
                        <i>üë§</i>
                        <span>Pasajero</span>
                    </div>
                    <div class="nav-item ${userRole === 'driver' ? 'active' : ''}" onclick="switchRole('driver')">
                        <i>üöó</i>
                        <span>Conductor</span>
                    </div>
                    <div class="nav-item" onclick="openHistory()">
                        <i>üìã</i>
                        <span>Historial</span>
                    </div>
                    <div class="nav-item" onclick="logout()">
                        <i>üö™</i>
                        <span>Salir</span>
                    </div>
                </div>
            `;
            
            setTimeout(initMap, 100);
            updatePanelForRole();
        }

        // ============================================
        // MAPA
        // ============================================
        function initMap() {
            if (map) map.remove();
            
            map = L.map('map').setView([-34.6037, -58.3816], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                map.setView([latitude, longitude], 15);
                
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([latitude, longitude]).addTo(map).bindPopup('Tu ubicaci√≥n');
                
                if (userRole === 'passenger' && !pickup) {
                    pickup = { lat: latitude, lng: longitude };
                }
            });
            
            map.on('click', (e) => {
                if (userRole === 'passenger' && !currentRide) {
                    dropoff = { lat: e.latlng.lat, lng: e.latlng.lng };
                    updateMarkers();
                    renderPassengerPanel();
                }
            });
        }

        function updateMarkers() {
            if (pickupMarker) map.removeLayer(pickupMarker);
            if (dropoffMarker) map.removeLayer(dropoffMarker);
            if (driverMarker) map.removeLayer(driverMarker);
            
            if (pickup) {
                pickupMarker = L.marker([pickup.lat, pickup.lng], {
                    icon: L.divIcon({ html: 'üìç', iconSize: [30, 30] })
                }).addTo(map).bindPopup('Origen');
            }
            if (dropoff) {
                dropoffMarker = L.marker([dropoff.lat, dropoff.lng], {
                    icon: L.divIcon({ html: 'üéØ', iconSize: [30, 30] })
                }).addTo(map).bindPopup('Destino');
            }
        }

        // ============================================
        // PANELES
        // ============================================
        function updatePanelForRole() {
            if (userRole === 'passenger') {
                renderPassengerPanel();
            } else {
                renderDriverPanel();
            }
            document.getElementById('slidePanel').classList.add('open');
        }

        function renderPassengerPanel() {
            const panel = document.getElementById('panelContent');
            if (!panel) return;
            
            let html = `<div class="panel-title">üöñ Solicitar Viaje</div>`;
            
            if (currentRide) {
                const statusText = {
                    'pending': 'Buscando conductor...',
                    'accepted': 'Conductor asignado',
                    'in_progress': 'Viaje en curso',
                    'completed': 'Viaje completado'
                };
                
                html += `
                    <div class="status-badge status-${currentRide.ride_status}">
                        ${statusText[currentRide.ride_status] || currentRide.ride_status}
                    </div>
                `;
                
                if (currentRide.driver) {
                    html += `
                        <div class="driver-info">
                            <div class="driver-avatar">üöó</div>
                            <div>
                                <h3>${currentRide.driver.full_name || 'Conductor'}</h3>
                                <p>‚≠ê 4.8 ¬∑ 150 viajes</p>
                                <p>üöó Auto negro ¬∑ ABC 123</p>
                            </div>
                        </div>
                        <button class="btn-secondary" onclick="centerMapOnDriver()">üìç Ver conductor en mapa</button>
                    `;
                }
                
                if (currentRide.ride_status === 'accepted') {
                    html += `<p style="margin-top: 10px;">El conductor est√° en camino</p>`;
                }
                
                html += `<button class="btn-danger" onclick="cancelRide()">‚ùå Cancelar viaje</button>`;
            } else {
                html += `
                    <button class="btn-secondary" onclick="setPickupHere()">üìç Usar mi ubicaci√≥n</button>
                    <button class="btn-secondary" onclick="setDropoffHere()">üéØ Destino aqu√≠</button>
                `;
                
                if (pickup && dropoff) {
                    const distance = getDistanceInMeters(pickup.lat, pickup.lng, dropoff.lat, dropoff.lng);
                    const blocks = metersToBlocks(distance);
                    const fare = calculateFare(blocks, 0);
                    
                    html += `
                        <div class="fare-estimate">
                            <div>
                                <strong>${blocks} cuadras</strong>
                                <p style="font-size: 12px;">Tarifa estimada</p>
                            </div>
                            <div class="fare-price">$${fare.total}</div>
                        </div>
                        <button class="btn-primary" onclick="requestRide()">üöñ Solicitar Viaje</button>
                    `;
                }
            }
            
            panel.innerHTML = html;
        }

        function renderDriverPanel() {
            const panel = document.getElementById('panelContent');
            if (!panel) return;
            
            if (currentRide) {
                const passenger = currentRide.passenger || {};
                panel.innerHTML = `
                    <div class="panel-title">üöó Viaje Actual</div>
                    <div class="status-badge status-${currentRide.ride_status}">
                        Estado: ${currentRide.ride_status}
                    </div>
                    <div class="ride-card">
                        <h3>üë§ Pasajero: ${passenger.full_name || 'Sin nombre'}</h3>
                        <p>üìç Origen: ${currentRide.pickup.lat.toFixed(4)}, ${currentRide.pickup.lng.toFixed(4)}</p>
                        <p>üéØ Destino: ${currentRide.dropoff.lat.toFixed(4)}, ${currentRide.dropoff.lng.toFixed(4)}</p>
                        <p>üí∞ Tarifa: $${currentRide.fare?.total}</p>
                    </div>
                    
                    ${currentRide.ride_status === 'accepted' ? `
                        <button class="btn-primary" onclick="startRide()">üü¢ Iniciar viaje</button>
                    ` : ''}
                    
                    ${currentRide.ride_status === 'in_progress' ? `
                        <button class="btn-primary" onclick="completeRide()">‚úÖ Completar viaje</button>
                    ` : ''}
                    
                    <button class="btn-secondary" onclick="centerMapOnPickup()">üìç Ver punto de encuentro</button>
                `;
            } else {
                let html = `<div class="panel-title">üöó Viajes Disponibles</div>`;
                
                if (pendingRequests.length === 0) {
                    html += `<p style="text-align: center; color: #666; padding: 20px;">No hay viajes disponibles</p>`;
                } else {
                    pendingRequests.forEach(ride => {
                        const distance = getDistanceInMeters(
                            ride.pickup.lat, ride.pickup.lng,
                            userMarker?.getLatLng()?.lat || 0, 
                            userMarker?.getLatLng()?.lng || 0
                        );
                        const blocks = metersToBlocks(distance);
                        
                        html += `
                            <div class="ride-card">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3>üí∞ $${ride.fare?.total}</h3>
                                        <p>üìè A ${blocks} cuadras</p>
                                        <p>üïê ${new Date(ride.created_at).toLocaleTimeString()}</p>
                                    </div>
                                    <button class="btn-primary" style="width: auto;" onclick="acceptRide('${ride.id}')">
                                        Aceptar
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                panel.innerHTML = html;
            }
        }

        // ============================================
        // ACCIONES DE USUARIO
        // ============================================
        window.handleLogin = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email, password
            });
            
            if (error) {
                alert('Error: ' + error.message);
            } else {
                currentUser = data.user;
                await loadUserProfile();
                await loadPendingRequests();
                subscribeToRides();
                startLocationTracking();
                renderMainApp();
                showNotification('¬°Bienvenido ' + userProfile?.full_name + '!');
            }
        };

        window.handleRegister = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { data, error } = await supabaseClient.auth.signUp({
                email, password,
                options: {
                    data: { full_name: email.split('@')[0] }
                }
            });
            
            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Registro exitoso! Ahora inicia sesi√≥n.');
            }
        };

        window.logout = async function() {
            await supabaseClient.auth.signOut();
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (activeChannel) activeChannel.unsubscribe();
            currentUser = null;
            renderLogin();
        };

        window.switchRole = async function(role) {
            if (role !== userRole) {
                await supabaseClient
                    .from('profiles')
                    .update({ user_role: role })
                    .eq('id', currentUser.id);
                
                userRole = role;
                pickup = null;
                dropoff = null;
                currentRide = null;
                renderMainApp();
                showNotification(`Ahora eres ${role === 'passenger' ? 'Pasajero' : 'Conductor'}`);
            }
        };

        window.togglePanel = function() {
            document.getElementById('slidePanel').classList.toggle('open');
        };

        window.setPickupHere = function() {
            if (!map || !userMarker) return;
            const pos = userMarker.getLatLng();
            pickup = { lat: pos.lat, lng: pos.lng };
            updateMarkers();
            renderPassengerPanel();
        };

        window.setDropoffHere = function() {
            if (!map) return;
            const center = map.getCenter();
            dropoff = { lat: center.lat, lng: center.lng };
            updateMarkers();
            renderPassengerPanel();
        };

        window.requestRide = async function() {
            if (!pickup || !dropoff) return;
            
            const distance = getDistanceInMeters(pickup.lat, pickup.lng, dropoff.lat, dropoff.lng);
            const blocks = metersToBlocks(distance);
            const fare = calculateFare(blocks, 0);
            
            const { data, error } = await supabaseClient
                .from('rides')
                .insert({
                    passenger_id: currentUser.id,
                    pickup: pickup,
                    dropoff: dropoff,
                    fare: fare,
                    ride_status: 'pending'
                })
                .select()
                .single();
            
            if (error) {
                alert('Error: ' + error.message);
            } else {
                currentRide = data;
                renderPassengerPanel();
                showNotification('Viaje solicitado! Buscando conductor...');
            }
        };

        window.acceptRide = async function(rideId) {
            const { error } = await supabaseClient
                .from('rides')
                .update({
                    driver_id: currentUser.id,
                    ride_status: 'accepted',
                    started_at: new Date()
                })
                .eq('id', rideId);
            
            if (error) {
                alert('Error: ' + error.message);
            } else {
                showNotification('¬°Viaje aceptado!');
                loadDriverLocation(currentUser.id);
            }
        };

        window.startRide = async function() {
            if (!currentRide) return;
            
            const { error } = await supabaseClient
                .from('rides')
                .update({ ride_status: 'in_progress' })
                .eq('id', currentRide.id);
            
            if (!error) {
                currentRide.ride_status = 'in_progress';
                renderDriverPanel();
                showNotification('Viaje iniciado');
            }
        };

        window.completeRide = async function() {
            if (!currentRide) return;
            
            const { error } = await supabaseClient
                .from('rides')
                .update({
                    ride_status: 'completed',
                    ended_at: new Date()
                })
                .eq('id', currentRide.id);
            
            if (!error) {
                currentRide = null;
                if (pickupMarker) map.removeLayer(pickupMarker);
                if (dropoffMarker) map.removeLayer(dropoffMarker);
                if (driverMarker) map.removeLayer(driverMarker);
                renderDriverPanel();
                showNotification('‚úÖ Viaje completado!');
            }
        };

        window.cancelRide = async function() {
            if (!currentRide) return;
            
            if (confirm('¬øCancelar el viaje?')) {
                const { error } = await supabaseClient
                    .from('rides')
                    .update({ ride_status: 'cancelled' })
                    .eq('id', currentRide.id);
                
                if (!error) {
                    currentRide = null;
                    renderPassengerPanel();
                    showNotification('Viaje cancelado');
                }
            }
        };

        window.centerMapOnDriver = function() {
            if (driverMarker) {
                map.setView(driverMarker.getLatLng(), 16);
            }
        };

        window.centerMapOnPickup = function() {
            if (currentRide?.pickup) {
                map.setView([currentRide.pickup.lat, currentRide.pickup.lng], 16);
            }
        };

        // ============================================
        // HISTORIAL
        // ============================================
        window.openHistory = async function() {
            const { data } = await supabaseClient
                .from('rides')
                .select('*')
                .or(`passenger_id.eq.${currentUser.id},driver_id.eq.${currentUser.id}`)
                .order('created_at', { ascending: false })
                .limit(20);
            
            const panel = document.getElementById('panelContent');
            
            if (!data || data.length === 0) {
                panel.innerHTML = `
                    <div class="panel-title">üìã Historial de Viajes</div>
                    <p style="text-align: center; color: #666; padding: 20px;">No hay viajes a√∫n</p>
                    <button class="btn-secondary" onclick="togglePanel()">Cerrar</button>
                `;
            } else {
                panel.innerHTML = `
                    <div class="panel-title">üìã Historial de Viajes</div>
                    ${data.map(ride => `
                        <div class="history-item" onclick="showRideDetails('${ride.id}')">
                            <div>
                                <strong>${new Date(ride.created_at).toLocaleDateString()}</strong>
                                <p style="font-size: 12px; color: #666;">${ride.ride_status}</p>
                            </div>
                            <div style="text-align: right;">
                                <strong style="color: #4CAF50;">$${ride.fare?.total || 0}</strong>
                                <p style="font-size: 12px;">${ride.passenger_id === currentUser.id ? 'üö∂ Como pasajero' : 'üöó Como conductor'}</p>
                            </div>
                        </div>
                    `).join('')}
                    <button class="btn-secondary" onclick="togglePanel()">Cerrar</button>
                `;
            }
            
            document.getElementById('slidePanel').classList.add('open');
        };

        // ============================================
        // SUSCRIPCIONES EN TIEMPO REAL
        // ============================================
        function subscribeToRides() {
            if (activeChannel) activeChannel.unsubscribe();
            
            activeChannel = supabaseClient
                .channel('rides-channel')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'rides' },
                    async (payload) => {
                        console.log('Cambio en viaje:', payload);
                        
                        // Si es un viaje nuevo y soy conductor, actualizar lista
                        if (payload.eventType === 'INSERT' && userRole === 'driver') {
                            await loadPendingRequests();
                        }
                        
                        // Si el viaje es el actual, actualizar UI
                        if (currentRide && payload.new.id === currentRide.id) {
                            currentRide = payload.new;
                            
                            // Si hay driver asignado, cargar su informaci√≥n
                            if (payload.new.driver_id && !currentRide.driver) {
                                await loadDriverInfo(payload.new.driver_id);
                            }
                            
                            // Actualizar panel seg√∫n rol
                            if (userRole === 'passenger') renderPassengerPanel();
                            if (userRole === 'driver') renderDriverPanel();
                            
                            // Mostrar notificaci√≥n seg√∫n cambio
                            if (payload.new.ride_status === 'accepted' && userRole === 'passenger') {
                                showNotification('üöó Conductor asignado!');
                            }
                            if (payload.new.ride_status === 'in_progress' && userRole === 'passenger') {
                                showNotification('üü¢ Viaje en curso');
                            }
                            if (payload.new.ride_status === 'completed') {
                                showNotification('‚úÖ Viaje completado');
                            }
                        }
                    }
                )
                .subscribe();
        }

        async function loadDriverInfo(driverId) {
            const { data } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', driverId)
                .single();
            
            if (data && currentRide) {
                currentRide.driver = data;
                if (userRole === 'passenger') renderPassengerPanel();
            }
        }

        async function loadDriverLocation(driverId) {
            // Suscribirse a ubicaci√≥n del conductor
            supabaseClient
                .channel('driver-location')
                .on(
                    'postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'driver_locations', filter: `driver_id=eq.${driverId}` },
                    (payload) => {
                        if (payload.new && payload.new.location) {
                            if (driverMarker) map.removeLayer(driverMarker);
                            driverMarker = L.marker([payload.new.location.lat, payload.new.location.lng], {
                                icon: L.divIcon({ html: 'üöó', iconSize: [30, 30] })
                            }).addTo(map).bindPopup('Conductor');
                        }
                    }
                )
                .subscribe();
        }

        // ============================================
        // C√ÅLCULOS
        // ============================================
        function getDistanceInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function metersToBlocks(meters) {
            return Math.ceil(meters / 120);
        }

        function calculateFare(blocks, waitingMinutes) {
            const baseBlocks = 25;
            const baseFare = appConfig.baseFare;
            const extraRate = appConfig.extraBlockRate;
            const waitingRate = appConfig.waitingRate;
            
            let distanceCost = baseFare;
            if (blocks > baseBlocks) {
                distanceCost = baseFare + ((blocks - baseBlocks) * extraRate);
            }
            
            const waitingCost = waitingMinutes * waitingRate;
            const subtotal = distanceCost + waitingCost;
            const total = subtotal * (1 + appConfig.commissionRate/100);
            
            return { total: Math.round(total) };
        }

        // ============================================
        // DATOS
        // ============================================
        async function loadConfig() {
            try {
                const { data } = await supabaseClient
                    .from('config')
                    .select('data')
                    .eq('id', 1)
                    .single();
                
                if (data) appConfig = { ...appConfig, ...data.data };
            } catch (error) {
                console.log('Usando configuraci√≥n por defecto');
            }
        }

        async function loadUserProfile() {
            const { data } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (data) {
                userProfile = data;
                userRole = data.user_role || 'passenger';
            }
        }

        async function loadPendingRequests() {
            const { data } = await supabaseClient
                .from('rides')
                .select('*')
                .eq('ride_status', 'pending')
                .order('created_at', { ascending: false });
            
            if (data) {
                pendingRequests = data;
                if (userRole === 'driver' && !currentRide) renderDriverPanel();
            }
        }

        function startLocationTracking() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            
            watchId = navigator.geolocation.watchPosition(pos => {
                const { latitude, longitude } = pos.coords;
                if (userMarker) {
                    userMarker.setLatLng([latitude, longitude]);
                }
                
                if (userRole === 'driver' && currentUser) {
                    supabaseClient
                        .from('driver_locations')
                        .upsert({
                            driver_id: currentUser.id,
                            location: { lat: latitude, lng: longitude },
                            updated_at: new Date()
                        });
                }
            }, null, { enableHighAccuracy: true, maximumAge: 0 });
        }

        // ============================================
        // AUTO-REFRESH
        // ============================================
        setInterval(loadPendingRequests, 5000);
    </script>
</body>
</html>
